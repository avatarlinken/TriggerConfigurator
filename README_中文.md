# 触发器配置器 (Trigger Configurator)

这是一个用于配置游戏控制器触发器反馈效果的应用程序，通过USB HID协议与控制器通信，可以设置不同模式下的触发器反馈参数。支持导入和应用JSON格式的武器配置文件，以及通过UDP协议接收武器切换命令。

## 功能概述

它允许用户选择不同的触发器模式（如通用模式、赛车模式、后座力模式等），并调整每种模式下的参数，以实现不同的触发器反馈效果。应用程序通过USB HID协议与控制器通信，实时发送配置命令。此外，它还支持通过UDP协议接收来自其他应用程序的武器切换命令，实现游戏内自动切换触发器配置。

## 主要功能

- **多种触发器模式**：支持5种不同的触发器反馈模式
- **参数实时调整**：通过滑块直观调整各种参数
- **USB HID通信**：实时将配置发送到控制器
- **武器配置管理**：加载和应用不同武器的触发器配置
- **UDP通信**：通过UDP接收外部应用发送的武器切换命令
- **直观的用户界面**：中文界面，操作简单明了

## 设计流程图

### 应用程序总体流程

```
+---------------------+     +--------------------+     +--------------------+
|                     |     |                    |     |                    |
| 启动应用程序           +---->+ 连接HID设备          +---->+ 初始化界面           |
|                     |     |                    |     |                    |
+---------------------+     +--------------------+     +---------+----------+
                                                                |
                                                                v
+---------------------+     +--------------------+     +--------------------+
|                     |     |                    |     |                    |
| 启动UDP服务器线程      <-----+ 监控设备连接状态       <-----+ 选择触发器模式        |
|                     |     |                    |     |                    |
+----------+----------+     +--------------------+     +--------------------+
           |
           v
+---------------------+     +--------------------+     +--------------------+
|                     |     |                    |     |                    |
| 等待用户操作           +---->+ 调整参数/加载配置      +---->+ 发送命令到设备       |
|                     |     |                    |     |                    |
+---------------------+     +--------------------+     +--------------------+
```

### HID通信流程

```
+---------------------+     +--------------------+     +--------------------+
|                     |     |                    |     |                    |
| 用户调整参数           +---->+ 生成命令帧           +---->+ 计算校验和           |
|                     |     |                    |     |                    |
+---------------------+     +--------------------+     +---------+----------+
                                                                |
                                                                v
                                                      +--------------------+
                                                      |                    |
                                                      | 发送HID报告到设备     |
                                                      |                    |
                                                      +--------------------+
```

### JSON配置文件处理流程

```
+---------------------+     +--------------------+     +--------------------+
|                     |     |                    |     |                    |
| 用户加载配置文件        +---->+ 解析JSON数据        +---->+ 提取武器列表          |
|                     |     |                    |     |                    |
+---------------------+     +--------------------+     +---------+----------+
                                                                |
                                                                v
+---------------------+     +--------------------+     +--------------------+
|                     |     |                    |     |                    |
| 应用触发器配置         <-----+ 获取触发器参数        <-----+ 用户选择武器          |
|                     |     |                    |     |                    |
+----------+----------+     +--------------------+     +--------------------+
           |
           v
+---------------------+
|                     |
| 发送命令到设备         |
|                     |
+---------------------+
```

### UDP通信流程

```
+---------------------+     +--------------------+     +--------------------+
|                     |     |                    |     |                    |
| UDP发送工具           +---->+   发送武器名称       +---->+ 触发器配置器接收       |
| (udp_sender.py)     |     |                    |     | 数据                |
+---------------------+     +--------------------+     +---------+----------+
                                                                |
                                                                v
                                                      +--------------------+
                                                      |                    |
                                                      | 解析武器名称          |
                                                      |                    |
                                                      +---------+----------+
                                                                |
                                                                v
                                                      +--------------------+
                                                      |                    |
                                                      | 应用对应触发器配置     |
                                                      |                    |
                                                      +--------------------+
```

## 模式与参数表

| 模式名称 | 模式ID | 参数 | 参数ID | 参数范围 | 功能描述 |
|---------|-------|------|-------|---------|---------|
| 通用模式 | 0x10 | 无参数 | - | - | 基础模式，无特殊反馈效果 |
| 赛车模式 | 0x11 | 阻尼开始位置 | 0x21 | 0-192 | 设置阻尼效果开始的触发器位置 |
|  |  | 阻尼强度 | 0x22 | 1-255 | 控制阻尼效果的强度 |
| 后座力模式 | 0x12 | 振动开始位置 | 0x31 | 0-192 | 设置振动效果开始的触发器位置 |
|  |  | 振动初始强度 | 0x32 | 1-255 | 控制振动开始时的初始强度 |
|  |  | 振动强度 | 0x33 | 1-255 | 控制振动效果的整体强度 |
|  |  | 振动频率 | 0x34 | 1-255 | 控制振动效果的频率 |
|  |  | 从振动开始位置开始输出数据 | 0x35 | 0/1 | 暂未启用 |
| 狙击模式 | 0x13 | 开始位置 | 0x41 | 0-192 | 设置狙击模式效果开始的触发器位置 |
|  |  | 触发行程 | 0x42 | 1-255 | 控制触发器的行程距离 |
|  |  | 阻力 | 0x43 | 1-255 | 控制狙击模式下的阻力大小 |
|  |  | 从断开开始位置开始输出数据 | 0x44 | 0/1 | 暂未启用 |
| 锁定模式 | 0x14 | 锁定阻尼开始位置 | 0x51 | 20-200 | 设置锁定模式下阻尼效果开始的位置 |

## 接口说明

### 1. USB HID通信接口

应用程序使用USB HID协议与设备通信，采用以下帧格式：

#### 命令帧格式

| 字节位置 | 描述 | 值/范围 |
|---------|------|---------|
| 0 | 报告ID | 0 (固定值) |
| 1 | 命令头 | 0xAA (固定值) |
| 2 | 命令类型 | 0x01(模式设置) 或 0x02(参数设置) |
| 3 | 数据长度 | 数据字节数 |
| 4+ | 数据 | 根据命令类型不同而变化 |
| N-2 | 校验和 | (命令类型 + 所有数据字节)的和 & 0xFF |
| N-1 | 命令尾 | 0x55 (固定值) |
| N+ | 填充 | 0x00 (填充至64字节) |

#### 命令类型

1. **模式设置命令 (0x01)**
   - 数据格式: [模式ID]
   - 模式ID定义:
     - 0x10: 通用模式 (General)
     - 0x11: 赛车模式 (Racing)
     - 0x12: 后座力模式 (Recoil)
     - 0x13: 狙击模式 (Sniper)
     - 0x14: 锁定模式 (Lock)

2. **参数设置命令 (0x02)**
   - 数据格式: [参数ID, 值高字节, 值低字节]
   - 参数ID采用分组编码（详见模式与参数表）

### 2. UDP通信接口

应用程序可以通过UDP协议接收外部应用发送的武器切换命令：

- **监听地址**：127.0.0.1
- **监听端口**：12345
- **数据格式**：UTF-8编码的武器名称字符串
- **支持的武器名称**：
  - "手枪"
  - "主武器"
  - "副武器"

## 源码文件说明

| 文件名 | 功能描述 |
|-------|---------|
| trigger_config_gui.py | 主程序，实现触发器配置器的GUI界面和核心功能 |
| udp_sender.py | UDP发送工具，用于测试向主程序发送武器切换命令 |
| requirements.txt | 依赖库列表 |
| Sniper5_dx12.default.json | 示例武器配置文件 |

## 类和方法概述

### trigger_config_gui.py

主要类：`TriggerConfigApp`

#### 核心方法

| 方法名 | 功能描述 |
|-------|---------|
| connect_device | 连接到HID设备 |
| disconnect_device | 断开HID设备连接 |
| select_mode | 选择触发器模式并更新UI |
| send_mode | 发送模式设置命令到设备 |
| send_parameter | 发送参数设置命令到设备 |
| send_all_parameters | 发送当前模式的所有参数到设备 |
| send_hid_report | 发送HID报告到设备 |
| apply_weapon_config | 应用武器配置到当前设置 |
| run_udp_server | 运行UDP服务器接收外部命令 |
| handle_udp_data | 处理接收到的UDP数据 |

### udp_sender.py

主要类：`UDPSenderApp`

#### 核心方法

| 方法名 | 功能描述 |
|-------|---------|
| send_weapon_command | 发送武器命令到UDP服务器 |

## JSON配置文件

### 配置文件格式

触发器配置器使用JSON格式的配置文件来存储不同武器的触发器参数设置。配置文件的基本结构如下：

```json
{
  "vFilters": [
    {
      "name": "手枪",
      "trigger": {
        "right": {
          "mode": 2,
          "param": [50, 100, 150, 200]
        }
      }
    },
    {
      "name": "主武器",
      "trigger": {
        "right": {
          "mode": 3,
          "param": [40, 80, 120, 0]
        }
      }
    }
  ],
  "trigger_default": {
    "right": {
      "mode": 0,
      "param": [0, 0, 0, 0]
    }
  }
}
```

### 配置文件字段说明

| 字段 | 说明 |
|------|------|
| vFilters | 武器配置数组，每个元素代表一种武器的配置 |
| name | 武器名称，在应用程序中显示并用于识别 |
| trigger.right.mode | 触发器模式ID（0=通用，1=赛车，2=后座力，3=狙击，4=锁定） |
| trigger.right.param | 参数数组，根据不同模式有不同含义 |
| trigger_default | 默认触发器配置，当找不到指定武器时使用 |

### 导入和应用JSON配置文件

#### 导入JSON配置文件的接口函数

| 函数名 | 参数 | 返回值 | 功能描述 |
|-------|------|-------|----------|
| load_weapon_config | file_path: 文件路径 | config_data: 配置数据或None | 加载武器配置JSON文件 |
| load_config_file | 无 | 无 | 打开文件选择对话框并加载配置文件 |
| get_weapon_trigger_config | config_data: 配置数据<br>weapon_name: 武器名称 | (mode_name, mode_value, trigger_params)或None | 根据武器名称获取触发器配置 |

#### 应用JSON配置文件的接口函数

| 函数名 | 参数 | 返回值 | 功能描述 |
|-------|------|-------|----------|
| apply_weapon_config | weapon_name: 武器名称<br>config_file_path: 配置文件路径(可选) | bool: 是否成功应用 | 应用武器配置到当前设置 |
| _apply_weapon_from_udp | weapon_name: 武器名称 | 无 | 在主线程中应用从UDP接收的武器配置 |

## 与UDP发送工具协同工作

触发器配置器可以通过UDP协议接收来自其他应用程序（如udp_sender.py）的武器切换命令，实现游戏内自动切换触发器配置。

### UDP通信接口表

| 项目 | 触发器配置器 (trigger_config_gui.py) | UDP发送工具 (udp_sender.py) |
|-----|-----------------------------------|----------------------------|
| 监听/发送地址 | 127.0.0.1 (监听) | 127.0.0.1 (发送) |
| 端口 | 12345 (监听) | 12345 (发送) |
| 数据格式 | UTF-8编码的武器名称字符串 | UTF-8编码的武器名称字符串 |
| 支持的武器名称 | "手枪"、"主武器"、"副武器" | "手枪"、"主武器"、"副武器" |
| 核心函数 | run_udp_server(): 启动UDP服务器<br>handle_udp_data(): 处理接收到的UDP数据 | send_weapon_command(): 发送武器命令 |
| 处理流程 | 1. 接收UDP数据<br>2. 解码武器名称<br>3. 在配置中查找匹配武器<br>4. 应用对应的触发器配置 | 1. 用户选择武器类型<br>2. 编码武器名称<br>3. 通过UDP发送到触发器配置器 |

### 使用UDP发送工具的步骤

1. 确保触发器配置器 (trigger_config_gui.py) 已运行并加载了武器配置文件
2. 运行UDP发送工具 (udp_sender.py)
3. 在UDP发送工具界面上点击对应的武器按钮
4. 触发器配置器会接收到武器切换命令并自动应用相应的触发器配置

## 系统要求

- Python 3.6+
- 依赖库：
  - hidapi
  - tkinter

## 安装与运行

1. 安装所需的包:
   ```
   pip install -r requirements.txt
   ```

2. 运行主应用程序:
   ```
   python trigger_config_gui.py
   ```

3. 运行UDP发送工具（可选，用于测试）:
   ```
   python udp_sender.py
   ```

## 使用方法

1. 启动应用程序后，它会自动尝试连接到HID设备
2. 选择所需的触发器模式（通用、赛车、后座力、狙击或锁定）
3. 调整所选模式的参数
4. 参数调整会实时发送到设备
5. 可以通过"加载配置文件"按钮加载武器配置文件
6. 选择武器后，会自动应用相应的触发器配置
7. 可以通过UDP发送工具或其他应用程序发送武器切换命令
